import { HeroPattern } from '@/components/HeroPattern'

<HeroPattern />

export const apiRefs = ['/autopay/settlement']

## Confirmar / Asentar pago {{ id: 'settlement', tag: 'POST', label: '/autopay/settlement' }}

Este endpoint es el **cierre oficial** de una transacción exitosa. AutoPay invocará este servicio únicamente cuando un cobro haya sido **APROBADO** por la red financiera.

Tu objetivo aquí es recibir la confirmación y registrar el pago en tu ERP, base de datos o sistema contable.

### Reglas de Negocio Recomendadas

1.  **Idempotencia:** Es posible que, por intermitencias de red, recibas esta confirmación más de una vez para la misma transacción. Tu sistema debe validar si el pago ya fue asentado previamente y responder `200 OK` sin duplicar el registro.
2.  **Validación de Monto:** Verifica que el `transaction.amount.total` coincida con lo que esperabas cobrar.
3.  **Respuesta Rápida:** Este proceso es síncrono. Responde lo más rápido posible (`< 3s`) para finalizar el ciclo.

---

<Row>
    <Col>
        <ApiReader
            path="/autopay/settlement"
            method="POST"
            api={props.refs}
        />
    </Col>
    <Col sticky={true}>
        <CodeGroup title="Solicitud" tag="POST" label="{{baseURl}}/autopay/settlement">
```bash {{ title: 'Settle a payment' }}
curl -X POST {{baseURl}}/autopay/settlement \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic <base64(username:password)>" \
  -d '{
    "reference": "ACC00012345",
    "id": "2972c13d-6315-4da3-80d7-64c24eb232ad",
    "transaction": {
      "status": {
        "status": "APPROVED",
        "reason": "00",
        "message": "Aprobada",
        "date": "2021-09-24T11:51:31-05:00"
      },
      "date": "2021-09-24T11:51:31-05:00",
      "transactionDate": "2021-09-24T11:51:31-05:00",
      "internalReference": 41,
      "reference": "ON1434012-PN1433129",
      "paymentMethod": "CR_VS",
      "franchise": "visa",
      "franchiseName": "Visa",
      "issuerName": "BANCO DE GUAYAQUIL, S.A.",
      "amount": {
        "taxes": [
          { "kind": "airportTax", "amount": 63, "base": 0 },
          { "kind": "valueAddedTax", "amount": 158.47, "base": 0 }
        ],
        "currency": "USD",
        "total": 1161.12
      },
      "conversion": {
        "from": { "currency": "USD", "total": 1161.12 },
        "to": { "currency": "USD", "total": 1161 },
        "factor": 1
      },
      "authorization": "739877",
      "receipt": "713329175945",
      "type": "AUTH_ONLY",
      "refunded": false,
      "lastDigits": "0032",
      "provider": "CREDIBANCO",
      "discount": null,
      "processorFields": {
        "id": "08c0284b20510c8db8dcb29137374718",
        "b24": "XX"
      },
      "additional": {
        "merchantCode": "123456",
        "terminalNumber": "12345678",
        "bin": "411076",
        "expiration": "1220"
      }
    }
  }'
```
        </CodeGroup>
    </Col>
</Row>

<Row>
    <Col>
        <ApiReader
            path="/autopay/settlement"
            method="POST"
            type="response"
            api={props.refs}
        />
    </Col>
    <Col sticky>
        <br />
        <CodeGroup title="Respuesta">
```json {{ title: '200: Respuesta exitosa' }}
{
  "status": {
    "status": "OK",
    "reason": "00",
    "message": "Respuesta sactisfactoria",
    "date": "2025-09-29T17:09:29-05:00"
  },
  "id": "2972c13d-6315-4da3-80d7-64c24eb232ad"
}
```
```json {{ title: '404: Transacción no encontrada' }}
{
  "status": {
    "status": "FAILED",
    "reason": "404",
    "message": "Transacción no encontrada",
    "date": "2025-09-29T17:09:29-05:00"
  }
}
```
```json {{ title: '400: Autenticación invalida' }}
{
    "status": {
        "status": "FAILED",
        "reason": "BR",
        "message": "Autenticación no proporcionada o encabezado Authorization mal formado.",
        "date": "2025-09-29T17:09:29-05:00"
    }
}
```
```json {{ title: '400: Autenticación invalida - Credenciales incorrectas' }}
{
    "status": {
        "status": "FAILED",
        "reason": "101",
        "message": "Credenciales inválidas.",
        "date": "2025-09-29T17:09:29-05:00"
   }
}
```
        </CodeGroup>
    </Col>
</Row>
